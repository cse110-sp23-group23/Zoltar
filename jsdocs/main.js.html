<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: main.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="HistoricalTicket.html">HistoricalTicket</a></div><div class="sidebar-section-children"><a href="LockedControls.html">LockedControls</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#addCardToScene">addCardToScene</a></div><div class="sidebar-section-children"><a href="global.html#addCardToScene">addCardToScene</a></div><div class="sidebar-section-children"><a href="global.html#animate">animate</a></div><div class="sidebar-section-children"><a href="global.html#animateFlickerFrame">animateFlickerFrame</a></div><div class="sidebar-section-children"><a href="global.html#animateShakeFrame">animateShakeFrame</a></div><div class="sidebar-section-children"><a href="global.html#animateTicketSlideFrame">animateTicketSlideFrame</a></div><div class="sidebar-section-children"><a href="global.html#calcMidDistance">calcMidDistance</a></div><div class="sidebar-section-children"><a href="global.html#cameraMove">cameraMove</a></div><div class="sidebar-section-children"><a href="global.html#canTriggerEvent">canTriggerEvent</a></div><div class="sidebar-section-children"><a href="global.html#canTriggerEvent">canTriggerEvent</a></div><div class="sidebar-section-children"><a href="global.html#chooseOptionFromArr">chooseOptionFromArr</a></div><div class="sidebar-section-children"><a href="global.html#clamp">clamp</a></div><div class="sidebar-section-children"><a href="global.html#closeAllSettingsTickets">closeAllSettingsTickets</a></div><div class="sidebar-section-children"><a href="global.html#closeExitPageMenu">closeExitPageMenu</a></div><div class="sidebar-section-children"><a href="global.html#conditionalAnimateSlideCameraFrame">conditionalAnimateSlideCameraFrame</a></div><div class="sidebar-section-children"><a href="global.html#convertArrToReadableString">convertArrToReadableString</a></div><div class="sidebar-section-children"><a href="global.html#createFortuneOnTicket">createFortuneOnTicket</a></div><div class="sidebar-section-children"><a href="global.html#createHitbox">createHitbox</a></div><div class="sidebar-section-children"><a href="global.html#deleteCard">deleteCard</a></div><div class="sidebar-section-children"><a href="global.html#didHitTicket">didHitTicket</a></div><div class="sidebar-section-children"><a href="global.html#displaySettingsTicket">displaySettingsTicket</a></div><div class="sidebar-section-children"><a href="global.html#displayStorage">displayStorage</a></div><div class="sidebar-section-children"><a href="global.html#exitHistory">exitHistory</a></div><div class="sidebar-section-children"><a href="global.html#exitPage">exitPage</a></div><div class="sidebar-section-children"><a href="global.html#eyeFrame">eyeFrame</a></div><div class="sidebar-section-children"><a href="global.html#fadeEyes">fadeEyes</a></div><div class="sidebar-section-children"><a href="global.html#findElementsInDOM">findElementsInDOM</a></div><div class="sidebar-section-children"><a href="global.html#flickerDelay">flickerDelay</a></div><div class="sidebar-section-children"><a href="global.html#flickerLights">flickerLights</a></div><div class="sidebar-section-children"><a href="global.html#flickVignette">flickVignette</a></div><div class="sidebar-section-children"><a href="global.html#flipTicket">flipTicket</a></div><div class="sidebar-section-children"><a href="global.html#getAllTickets">getAllTickets</a></div><div class="sidebar-section-children"><a href="global.html#getNextSelected">getNextSelected</a></div><div class="sidebar-section-children"><a href="global.html#getSettingsLocalStorage">getSettingsLocalStorage</a></div><div class="sidebar-section-children"><a href="global.html#handleHoverListeners">handleHoverListeners</a></div><div class="sidebar-section-children"><a href="global.html#handleKeydown">handleKeydown</a></div><div class="sidebar-section-children"><a href="global.html#handleKeypress">handleKeypress</a></div><div class="sidebar-section-children"><a href="global.html#handleKeypress">handleKeypress</a></div><div class="sidebar-section-children"><a href="global.html#handleResize">handleResize</a></div><div class="sidebar-section-children"><a href="global.html#handleResize">handleResize</a></div><div class="sidebar-section-children"><a href="global.html#helperClampLonLat">helperClampLonLat</a></div><div class="sidebar-section-children"><a href="global.html#hideSavePrompt">hideSavePrompt</a></div><div class="sidebar-section-children"><a href="global.html#historyIsOpen">historyIsOpen</a></div><div class="sidebar-section-children"><a href="global.html#isSaveDiscardVisible">isSaveDiscardVisible</a></div><div class="sidebar-section-children"><a href="global.html#isTicketCurrentlyDisplayed">isTicketCurrentlyDisplayed</a></div><div class="sidebar-section-children"><a href="global.html#isTicketCurrentlyFlipped">isTicketCurrentlyFlipped</a></div><div class="sidebar-section-children"><a href="global.html#keyHandler">keyHandler</a></div><div class="sidebar-section-children"><a href="global.html#loadJsonArr">loadJsonArr</a></div><div class="sidebar-section-children"><a href="global.html#mute">mute</a></div><div class="sidebar-section-children"><a href="global.html#onPointerMove">onPointerMove</a></div><div class="sidebar-section-children"><a href="global.html#openEightBall">openEightBall</a></div><div class="sidebar-section-children"><a href="global.html#options">options</a></div><div class="sidebar-section-children"><a href="global.html#playAudio">playAudio</a></div><div class="sidebar-section-children"><a href="global.html#playRandomVoiceLine">playRandomVoiceLine</a></div><div class="sidebar-section-children"><a href="global.html#produceFortune">produceFortune</a></div><div class="sidebar-section-children"><a href="global.html#produceFortuneFromGPT">produceFortuneFromGPT</a></div><div class="sidebar-section-children"><a href="global.html#produceRandomNumbers">produceRandomNumbers</a></div><div class="sidebar-section-children"><a href="global.html#putSettingsLocalStorage">putSettingsLocalStorage</a></div><div class="sidebar-section-children"><a href="global.html#refreshSettingsMenu">refreshSettingsMenu</a></div><div class="sidebar-section-children"><a href="global.html#safeToExit">safeToExit</a></div><div class="sidebar-section-children"><a href="global.html#saveAllStates">saveAllStates</a></div><div class="sidebar-section-children"><a href="global.html#saveState">saveState</a></div><div class="sidebar-section-children"><a href="global.html#setControls">setControls</a></div><div class="sidebar-section-children"><a href="global.html#setSafeToExitFunc">setSafeToExitFunc</a></div><div class="sidebar-section-children"><a href="global.html#setTicketMapToImage">setTicketMapToImage</a></div><div class="sidebar-section-children"><a href="global.html#settingsTicketHandler">settingsTicketHandler</a></div><div class="sidebar-section-children"><a href="global.html#shootRay">shootRay</a></div><div class="sidebar-section-children"><a href="global.html#shouldFlickerOff">shouldFlickerOff</a></div><div class="sidebar-section-children"><a href="global.html#shouldFlickerOn">shouldFlickerOn</a></div><div class="sidebar-section-children"><a href="global.html#slide">slide</a></div><div class="sidebar-section-children"><a href="global.html#slowHideElement">slowHideElement</a></div><div class="sidebar-section-children"><a href="global.html#startShaking">startShaking</a></div><div class="sidebar-section-children"><a href="global.html#startShaking">startShaking</a></div><div class="sidebar-section-children"><a href="global.html#startThinkingAnimation">startThinkingAnimation</a></div><div class="sidebar-section-children"><a href="global.html#tellPageLoaded">tellPageLoaded</a></div><div class="sidebar-section-children"><a href="global.html#template">template</a></div><div class="sidebar-section-children"><a href="global.html#toggleClassToArr">toggleClassToArr</a></div><div class="sidebar-section-children"><a href="global.html#toggleMute">toggleMute</a></div><div class="sidebar-section-children"><a href="global.html#toggleSettingsContainer">toggleSettingsContainer</a></div><div class="sidebar-section-children"><a href="global.html#toggleTicketOff">toggleTicketOff</a></div><div class="sidebar-section-children"><a href="global.html#toggleTicketOn">toggleTicketOn</a></div><div class="sidebar-section-children"><a href="global.html#translateCards">translateCards</a></div><div class="sidebar-section-children"><a href="global.html#tryToStartSequence">tryToStartSequence</a></div><div class="sidebar-section-children"><a href="global.html#unmute">unmute</a></div><div class="sidebar-section-children"><a href="global.html#update">update</a></div><div class="sidebar-section-children"><a href="global.html#updateAudioOutput">updateAudioOutput</a></div><div class="sidebar-section-children"><a href="global.html#updateCounts">updateCounts</a></div><div class="sidebar-section-children"><a href="global.html#updateSliderFromInput">updateSliderFromInput</a></div><div class="sidebar-section-children"><a href="global.html#updateTicket">updateTicket</a></div><div class="sidebar-section-children"><a href="global.html#validateNumInput">validateNumInput</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">main.js</h1></header><article><pre class="prettyprint source lang-js"><code>import {
	AmbientLight,
	SphereGeometry,
	Clock,
	LoadingManager,
	Mesh,
	MeshBasicMaterial,
	MeshLambertMaterial,
	PerspectiveCamera,
	Raycaster,
	Scene,
	SpotLight,
	TextureLoader,
	Vector2,
	Vector3,
	WebGLRenderer,
	Group,
} from 'three'; // eslint-disable-line import/no-unresolved
// eslint-disable-next-line import/no-unresolved
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import {
	animateShakeFrame,
	animateFlickerFrame,
	animateTicketSlideFrame,
	conditionalAnimateSlideCameraFrame,
} from './animationframes.js';
import LockedControls from './LockedControls.js';
import { isTicketCurrentlyDisplayed, isSaveDiscardVisible, toggleTicketOn } from './ticket.js';
import { tellPageLoaded } from './splash.js';
import { createFortuneOnTicket } from './fortunes.js';
import { flickerDelay, flickVignette } from './util.js';
import { options } from './options.js';
import { setControls, setSafeToExitFunc } from './settings.js';
import { playAudio, playRandomVoiceLine } from './noise.js';

// eslint-disable-next-line no-console
console.log('%cWelcome to %cZoltar%c.live!', '', 'color: red; font-weight: bolder', '');

const state = {
	currentShakeDuration: 0,
	responseGenerated: true,
	shakeEndHappened: true,
	currentFlickerCount: 0,
	slideCameraTowardDefault: false,
	ticketSpawned: false,
	ticketDoneSliding: false,
	flickerOn: false,
	flickerTime: 0,
	curFlickerOffInterval: options.flicker.timingFunc(), // changes each iteration
	shakeDeltaVec: new Vector3(),
};

const dom = {};

// Load 3D scene and necessary objects
const scene = new Scene();
const clock = new Clock();
const manager = new LoadingManager();
const raycaster = new Raycaster();
const pointer = new Vector2();
const textureLoader = new TextureLoader();
const loader = new GLTFLoader(manager);
const renderer = new WebGLRenderer({ alpha: false });
const camera = new PerspectiveCamera(25, window.innerWidth / window.innerHeight, 1, 2000);

// Light creation
const spotlight = new SpotLight(options.light.spotlightColor, options.light.spotlightItensity);
const ambient = new AmbientLight(options.light.ambientColor, options.light.ambientIntensity);

// Load camera perspective
camera.position.copy(options.camera.defaultPosition);

// Load renderer
renderer.setClearColor(0x000000);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Load custom controls and turn off by default
export const controls = new LockedControls(camera, renderer.domElement);
controls.API.enabled = false;
setControls(controls);

// glTf 2.0 Loader
loader.load('assets/models/zoltarmain.glb', (gltf) => {
	const object = gltf.scene;
	object.scale.copy(options.model.scale);
	object.position.copy(options.model.position);
	scene.add(object);
});

/**
 * Creates and returns a general transparent rectangular object (i.e. hitbox)
 * @param { Object } settings object holding all the specs for hitbox
 * @return { Object3D } hitbox object
 */
function createHitbox(settings) {
	const mat = new MeshBasicMaterial({
		color: 0xff00ff,
		opacity: 0, // set to pos to display hitbox for testing
		transparent: true,
		depthWrite: false,
	});
	const hitbox = new Mesh(settings.geometry, mat);
	hitbox.position.copy(settings.position);
	hitbox.rotateY(settings.rotateY);
	scene.add(hitbox);
	return hitbox;
} /* settings */

// Hitboxes
const zoltarHitbox = createHitbox(options.machineHitbox);
const ticketHitbox = createHitbox(options.ticketHitbox);

// Ticket
options.ticketMat.material.roughness = 1;
const ticket = new Mesh(options.ticketMat.geometry, options.ticketMat.material);
ticket.rotateY(options.ticketMat.rotationY);

// Light placement
spotlight.position.copy(options.light.spotlightPos);
spotlight.target.position.copy(options.light.spotlightTarget);
spotlight.angle = options.light.spotlightAngle;
spotlight.distance = options.light.spotlightDistance;
spotlight.penumbra = 1;
spotlight.castShadow = true;
scene.add(spotlight.target);
scene.add(spotlight);
scene.add(ambient);

// Glowing eyes setup
const eyeGroup = new Group();
const eyeLayers = [];
const eyeMat = new MeshLambertMaterial({
	color: options.eyes.color,
	transparent: true,
	depthWrite: false,
});
for (let i = 0; i &lt; 1; i += options.eyes.stepSize) {
	const newMat = eyeMat.clone();
	newMat.opacity = options.eyes.baseOpacity * (1 - (i ** (options.eyes.stepSize * 2)));
	const layerGeo = new SphereGeometry(options.eyes.baseSize + (i * i) / 2);
	layerGeo.scale(2, 1, 2);
	const layer = new Mesh(layerGeo, newMat);
	const eyeLayer = new Group();
	const leftEyeLayer = layer;
	const rightEyeLayer = layer.clone(true);
	leftEyeLayer.position.copy(options.eyes.leftEyePos);
	rightEyeLayer.position.copy(options.eyes.rightEyePos);
	eyeLayer.attach(leftEyeLayer);
	eyeLayer.attach(rightEyeLayer);
	eyeLayers.push(eyeLayer);
}
scene.add(eyeGroup);

/**
 * Returns whether or not new event can be queued
 * @param none
 * @return { Boolean }
 */
export function canTriggerEvent() {
	return !isTicketCurrentlyDisplayed()
		&amp;&amp; controls.API.enabled
		&amp;&amp; !state.ticketSpawned
		&amp;&amp; document.querySelector('.cover').classList.contains('hidden');
} /* canTriggerEvent */

/**
 * Sets ticket texture to image at appropriate url for input
 * @param { String } nameOfImage name of image in format of prefix-name structure
 */
export function setTicketMapToImage(nameOfImage) {
	const mapTexture = textureLoader.load(`${options.ticketMat.urlPrefix}${nameOfImage}-map.webp`);
	options.ticketMat.material.map = mapTexture;
} /* setTicketMapToImage */

/**
 * Animates fading (quick, slow, hold) of eyes onto screen
 * @param { String } dir string 'remove' or 'add' representing fading direction
 * @param { String } numLayers if adding, number of layers to add. Remove always removes everything
 */
function fadeEyes(dir, speed, numLayers) {
	if (dir !== 'add' &amp;&amp; dir !== 'remove') return;
	eyeLayers.forEach((layer, i) => {
		if (dir === 'add' &amp;&amp; i >= numLayers) return;
		setTimeout(() => {
			eyeGroup[dir](layer);
		}, speed * i);
	});
} /* fadeEyes */

/**
 * Adds/removes eye from scene and creates promise to allow next action in delay ms
 * @param { Array } frame of form [action, numLayers, speed, timeUntilNextMS], action either 'add' or 'remove'
 * 		and layers only effect 'add' action
 * @return { Promise } promise to resolve in a set delay length
 */
function eyeFrame(frame) {
	fadeEyes(frame[0], frame[2], frame[1]);
	return flickerDelay(frame[3]);
} /* eyeFrame */

/**
 * Triggers the screen to shake for predetermined time. Ticket dispenses after
 * shaking is completed
 * @param none
 */
function startShaking() {
	playAudio('rumble', 0.3);
	playRandomVoiceLine();
	state.currentShakeDuration = options.shake.minDurationMS / 1000;
} /* startShaking */

/**
 * Starts animation sequence for ticket dispense action
 * @param none
 */
function startThinkingAnimation() {
	options.eyes.frames.reduce((prev, cur) => prev.then(() => eyeFrame(cur)), Promise.resolve())
		.then(() => { setTimeout(startShaking, 500); });
} /* startThinkingAnimation */

/**
 * Generates card and displays on screen
 * @param none
 */
function addCardToScene() {
	toggleTicketOn();
	fadeEyes('remove', 10);
	scene.remove(ticket);
	state.ticketSpawned = false;
	controls.API.enabled = false;
} /* addCardToScene */

/**
 * Starts ticket deployment process (i.e. on space or lmb press) if
 * possible at time of call, otherwise nothing
 * @param none
 */
function tryToStartSequence() {
	if (!canTriggerEvent()) return;
	state.ticketSpawned = true;
	state.responseGenerated = false;
	flickVignette();
	startThinkingAnimation();
	const paramOptions = {
		callback: (ticketState) => {
			state.responseGenerated = true;
			setTicketMapToImage(ticketState.currentImageBack);
		},
	};
	createFortuneOnTicket(paramOptions);
} /* tryToStartSequence */

/**
 * Helper to return if ray cast hit hitbox and ticket was indeed there
 * @param { Array&lt;Object3D> } intersections array of objects collided by ray
 * @return { Boolean } true if intersection validly hit ticket('s hitbox)
*/
function didHitTicket(intersections) {
	return (intersections.includes(ticketHitbox) || intersections.includes(ticket))
		&amp;&amp; state.ticketSpawned
		&amp;&amp; state.ticketDoneSliding
		&amp;&amp; ticket.parent === scene;
} /* didHitTicket */

/**
 * Shoots ray from camera and measures instersection with hitbox of
 * ticket; if hit, displays cards. If hits machine, starts sequence like space.
 * @param { Object } event event listener action
 */
function shootRay(event) {
	pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
	pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
	raycaster.setFromCamera(pointer, camera);
	const intersects = raycaster.intersectObjects([ticketHitbox, ticket, zoltarHitbox]);
	const interObjects = intersects.map((inter) => inter.object);
	if (didHitTicket(interObjects)) {
		addCardToScene();
	} else if (interObjects.includes(zoltarHitbox)) {
		tryToStartSequence();
	}
} /* shootRay */

/**
 * Decides and calls appropriate action for all keypresses heard in window
 * @param { Event } event - keypress event passed by eventlistener
 */
function handleKeypress(event) {
	if (event.key === ' ') tryToStartSequence();
} /* handleKeypress */

/**
 * Prevents damage from window resize to camera controls and viewport
 * @param none
 */
function handleResize() {
	const width = window.innerWidth;
	const height = window.innerHeight;
	renderer.setSize(width, height);
	camera.aspect = width / height;
	camera.updateProjectionMatrix();
} /* handleResize */

/**
 * Returns if leaving now will risk losing important data (e.g. ticket is not saved)
 * @param none
 * @return { Boolean }
 */
function safeToExit() {
	return !isTicketCurrentlyDisplayed() &amp;&amp; !state.ticketSpawned &amp;&amp; !isSaveDiscardVisible();
} /* safeToExit */
setSafeToExitFunc(safeToExit); // setter for function in settings.js

/**
 * Animation farm; generates each frame and calls self
 * @param none
 */
function animate() {
	const delta = clock.getDelta();
	const args = {
		state, options, ticket, camera, scene, ambient,
	};
	animateShakeFrame(delta, args);
	animateFlickerFrame(delta, args);
	animateTicketSlideFrame(delta, args);
	conditionalAnimateSlideCameraFrame(delta, args);
	controls.update(delta);
	renderer.render(scene, camera);
	requestAnimationFrame(animate);
} /* animate */

function init() {
	dom.buttons = [
		document.querySelector('#save-button'),
		document.querySelector('#discard-button'),
	];
	dom.buttons.forEach((el) => {
		el.addEventListener('click', () => {
			controls.API.enabled = true;
		});
	});

	renderer.domElement.addEventListener('click', shootRay);
	window.addEventListener('keydown', handleKeypress);
	window.addEventListener('resize' || 'focus', handleResize);
	renderer.domElement.addEventListener('mouseenter', handleResize);

	window.addEventListener('beforeunload', (event) => {
		const message = 'Leaving now will cause your ticket to be lost. Are you sure?';
		if (safeToExit()) {
			event.preventDefault();
			return;
		}
		// eslint-disable-next-line no-param-reassign
		event.returnValue = message;
	});

	manager.onLoad = () => { tellPageLoaded(controls); };

	animate();
} /* init */

document.addEventListener('DOMContentLoaded', init);
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="HistoricalTicket.html">HistoricalTicket</a></div><div class="sidebar-section-children"><a href="LockedControls.html">LockedControls</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#addCardToScene">addCardToScene</a></div><div class="sidebar-section-children"><a href="global.html#addCardToScene">addCardToScene</a></div><div class="sidebar-section-children"><a href="global.html#animate">animate</a></div><div class="sidebar-section-children"><a href="global.html#animateFlickerFrame">animateFlickerFrame</a></div><div class="sidebar-section-children"><a href="global.html#animateShakeFrame">animateShakeFrame</a></div><div class="sidebar-section-children"><a href="global.html#animateTicketSlideFrame">animateTicketSlideFrame</a></div><div class="sidebar-section-children"><a href="global.html#calcMidDistance">calcMidDistance</a></div><div class="sidebar-section-children"><a href="global.html#cameraMove">cameraMove</a></div><div class="sidebar-section-children"><a href="global.html#canTriggerEvent">canTriggerEvent</a></div><div class="sidebar-section-children"><a href="global.html#canTriggerEvent">canTriggerEvent</a></div><div class="sidebar-section-children"><a href="global.html#chooseOptionFromArr">chooseOptionFromArr</a></div><div class="sidebar-section-children"><a href="global.html#clamp">clamp</a></div><div class="sidebar-section-children"><a href="global.html#closeAllSettingsTickets">closeAllSettingsTickets</a></div><div class="sidebar-section-children"><a href="global.html#closeExitPageMenu">closeExitPageMenu</a></div><div class="sidebar-section-children"><a href="global.html#conditionalAnimateSlideCameraFrame">conditionalAnimateSlideCameraFrame</a></div><div class="sidebar-section-children"><a href="global.html#convertArrToReadableString">convertArrToReadableString</a></div><div class="sidebar-section-children"><a href="global.html#createFortuneOnTicket">createFortuneOnTicket</a></div><div class="sidebar-section-children"><a href="global.html#createHitbox">createHitbox</a></div><div class="sidebar-section-children"><a href="global.html#deleteCard">deleteCard</a></div><div class="sidebar-section-children"><a href="global.html#didHitTicket">didHitTicket</a></div><div class="sidebar-section-children"><a href="global.html#displaySettingsTicket">displaySettingsTicket</a></div><div class="sidebar-section-children"><a href="global.html#displayStorage">displayStorage</a></div><div class="sidebar-section-children"><a href="global.html#exitHistory">exitHistory</a></div><div class="sidebar-section-children"><a href="global.html#exitPage">exitPage</a></div><div class="sidebar-section-children"><a href="global.html#eyeFrame">eyeFrame</a></div><div class="sidebar-section-children"><a href="global.html#fadeEyes">fadeEyes</a></div><div class="sidebar-section-children"><a href="global.html#findElementsInDOM">findElementsInDOM</a></div><div class="sidebar-section-children"><a href="global.html#flickerDelay">flickerDelay</a></div><div class="sidebar-section-children"><a href="global.html#flickerLights">flickerLights</a></div><div class="sidebar-section-children"><a href="global.html#flickVignette">flickVignette</a></div><div class="sidebar-section-children"><a href="global.html#flipTicket">flipTicket</a></div><div class="sidebar-section-children"><a href="global.html#getAllTickets">getAllTickets</a></div><div class="sidebar-section-children"><a href="global.html#getNextSelected">getNextSelected</a></div><div class="sidebar-section-children"><a href="global.html#getSettingsLocalStorage">getSettingsLocalStorage</a></div><div class="sidebar-section-children"><a href="global.html#handleHoverListeners">handleHoverListeners</a></div><div class="sidebar-section-children"><a href="global.html#handleKeydown">handleKeydown</a></div><div class="sidebar-section-children"><a href="global.html#handleKeypress">handleKeypress</a></div><div class="sidebar-section-children"><a href="global.html#handleKeypress">handleKeypress</a></div><div class="sidebar-section-children"><a href="global.html#handleResize">handleResize</a></div><div class="sidebar-section-children"><a href="global.html#handleResize">handleResize</a></div><div class="sidebar-section-children"><a href="global.html#helperClampLonLat">helperClampLonLat</a></div><div class="sidebar-section-children"><a href="global.html#hideSavePrompt">hideSavePrompt</a></div><div class="sidebar-section-children"><a href="global.html#historyIsOpen">historyIsOpen</a></div><div class="sidebar-section-children"><a href="global.html#isSaveDiscardVisible">isSaveDiscardVisible</a></div><div class="sidebar-section-children"><a href="global.html#isTicketCurrentlyDisplayed">isTicketCurrentlyDisplayed</a></div><div class="sidebar-section-children"><a href="global.html#isTicketCurrentlyFlipped">isTicketCurrentlyFlipped</a></div><div class="sidebar-section-children"><a href="global.html#keyHandler">keyHandler</a></div><div class="sidebar-section-children"><a href="global.html#loadJsonArr">loadJsonArr</a></div><div class="sidebar-section-children"><a href="global.html#mute">mute</a></div><div class="sidebar-section-children"><a href="global.html#onPointerMove">onPointerMove</a></div><div class="sidebar-section-children"><a href="global.html#openEightBall">openEightBall</a></div><div class="sidebar-section-children"><a href="global.html#options">options</a></div><div class="sidebar-section-children"><a href="global.html#playAudio">playAudio</a></div><div class="sidebar-section-children"><a href="global.html#playRandomVoiceLine">playRandomVoiceLine</a></div><div class="sidebar-section-children"><a href="global.html#produceFortune">produceFortune</a></div><div class="sidebar-section-children"><a href="global.html#produceFortuneFromGPT">produceFortuneFromGPT</a></div><div class="sidebar-section-children"><a href="global.html#produceRandomNumbers">produceRandomNumbers</a></div><div class="sidebar-section-children"><a href="global.html#putSettingsLocalStorage">putSettingsLocalStorage</a></div><div class="sidebar-section-children"><a href="global.html#refreshSettingsMenu">refreshSettingsMenu</a></div><div class="sidebar-section-children"><a href="global.html#safeToExit">safeToExit</a></div><div class="sidebar-section-children"><a href="global.html#saveAllStates">saveAllStates</a></div><div class="sidebar-section-children"><a href="global.html#saveState">saveState</a></div><div class="sidebar-section-children"><a href="global.html#setControls">setControls</a></div><div class="sidebar-section-children"><a href="global.html#setSafeToExitFunc">setSafeToExitFunc</a></div><div class="sidebar-section-children"><a href="global.html#setTicketMapToImage">setTicketMapToImage</a></div><div class="sidebar-section-children"><a href="global.html#settingsTicketHandler">settingsTicketHandler</a></div><div class="sidebar-section-children"><a href="global.html#shootRay">shootRay</a></div><div class="sidebar-section-children"><a href="global.html#shouldFlickerOff">shouldFlickerOff</a></div><div class="sidebar-section-children"><a href="global.html#shouldFlickerOn">shouldFlickerOn</a></div><div class="sidebar-section-children"><a href="global.html#slide">slide</a></div><div class="sidebar-section-children"><a href="global.html#slowHideElement">slowHideElement</a></div><div class="sidebar-section-children"><a href="global.html#startShaking">startShaking</a></div><div class="sidebar-section-children"><a href="global.html#startShaking">startShaking</a></div><div class="sidebar-section-children"><a href="global.html#startThinkingAnimation">startThinkingAnimation</a></div><div class="sidebar-section-children"><a href="global.html#tellPageLoaded">tellPageLoaded</a></div><div class="sidebar-section-children"><a href="global.html#template">template</a></div><div class="sidebar-section-children"><a href="global.html#toggleClassToArr">toggleClassToArr</a></div><div class="sidebar-section-children"><a href="global.html#toggleMute">toggleMute</a></div><div class="sidebar-section-children"><a href="global.html#toggleSettingsContainer">toggleSettingsContainer</a></div><div class="sidebar-section-children"><a href="global.html#toggleTicketOff">toggleTicketOff</a></div><div class="sidebar-section-children"><a href="global.html#toggleTicketOn">toggleTicketOn</a></div><div class="sidebar-section-children"><a href="global.html#translateCards">translateCards</a></div><div class="sidebar-section-children"><a href="global.html#tryToStartSequence">tryToStartSequence</a></div><div class="sidebar-section-children"><a href="global.html#unmute">unmute</a></div><div class="sidebar-section-children"><a href="global.html#update">update</a></div><div class="sidebar-section-children"><a href="global.html#updateAudioOutput">updateAudioOutput</a></div><div class="sidebar-section-children"><a href="global.html#updateCounts">updateCounts</a></div><div class="sidebar-section-children"><a href="global.html#updateSliderFromInput">updateSliderFromInput</a></div><div class="sidebar-section-children"><a href="global.html#updateTicket">updateTicket</a></div><div class="sidebar-section-children"><a href="global.html#validateNumInput">validateNumInput</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>