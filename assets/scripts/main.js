import{AmbientLight as e,SphereGeometry as t,Clock as n,LoadingManager as a,Mesh as i,MeshBasicMaterial as o,MeshLambertMaterial as W,PerspectiveCamera as z,Raycaster as H,Scene as O,SpotLight as V,TextureLoader as R,Vector2 as Y,Vector3 as q,WebGLRenderer as B,Group as r}from"three";import{GLTFLoader as X}from"three/addons/loaders/GLTFLoader.js";import{animateShakeFrame as Z,animateFlickerFrame as J,animateTicketSlideFrame as K,conditionalAnimateSlideCameraFrame as N}from"./animationframes.js";import Q from"./LockedControls.js";import{isTicketCurrentlyDisplayed as s,isSaveDiscardVisible as U,toggleTicketOn as $}from"./ticket.js";import{tellPageLoaded as _}from"./splash.js";import{createFortuneOnTicket as ee}from"./fortunes.js";import{flickerDelay as te,flickVignette as ne}from"./util.js";import{options as c}from"./options.js";import{setControls as ae,setSafeToExitFunc as ie}from"./settings.js";import{playAudio as oe,playRandomVoiceLine as re}from"./noise.js";console.log("%cWelcome to %cZoltar%c.live!","","color: red; font-weight: bolder","");const d={currentShakeDuration:0,responseGenerated:!0,shakeEndHappened:!0,currentFlickerCount:0,slideCameraTowardDefault:!1,ticketSpawned:!1,ticketDoneSliding:!1,flickerOn:!1,flickerTime:0,curFlickerOffInterval:c.flicker.timingFunc(),shakeDeltaVec:new q},l={},m=new O,se=new n,p=new a,u=new H,w=new Y,ce=new R;var de=new X(p);const h=new B({alpha:!1}),f=new z(25,window.innerWidth/window.innerHeight,1,2e3);var g=new V(c.light.spotlightColor,c.light.spotlightItensity);const k=new e(c.light.ambientColor,c.light.ambientIntensity),y=(f.position.copy(c.camera.defaultPosition),h.setClearColor(0),h.setPixelRatio(window.devicePixelRatio),h.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(h.domElement),new Q(f,h.domElement));function b(e){var t=new o({color:16711935,opacity:0,transparent:!0,depthWrite:!1}),t=new i(e.geometry,t);return t.position.copy(e.position),t.rotateY(e.rotateY),m.add(t),t}y.API.enabled=!1,ae(y),de.load("assets/models/zoltarmain.glb",e=>{e=e.scene;e.scale.copy(c.model.scale),e.position.copy(c.model.position),m.add(e)});const v=b(c.machineHitbox),S=b(c.ticketHitbox),L=(c.ticketMat.material.roughness=1,new i(c.ticketMat.geometry,c.ticketMat.material)),E=(L.rotateY(c.ticketMat.rotationY),g.position.copy(c.light.spotlightPos),g.target.position.copy(c.light.spotlightTarget),g.angle=c.light.spotlightAngle,g.distance=c.light.spotlightDistance,g.penumbra=1,g.castShadow=!0,m.add(g.target),m.add(g),m.add(k),new r),C=[];var le=new W({color:c.eyes.color,transparent:!0,depthWrite:!1});for(let e=0;e<1;e+=c.eyes.stepSize){var M=le.clone(),P=(M.opacity=c.eyes.baseOpacity*(1-e**(2*c.eyes.stepSize)),new t(c.eyes.baseSize+e*e/2)),P=(P.scale(2,1,2),new i(P,M)),M=new r,D=P,P=P.clone(!0);D.position.copy(c.eyes.leftEyePos),P.position.copy(c.eyes.rightEyePos),M.attach(D),M.attach(P),C.push(M)}function F(){return!s()&&y.API.enabled&&!d.ticketSpawned&&document.querySelector(".cover").classList.contains("hidden")}function j(e){e=ce.load(""+c.ticketMat.urlPrefix+e+"-map.webp");c.ticketMat.material.map=e}function T(n,a,i){"add"!==n&&"remove"!==n||C.forEach((e,t)=>{"add"===n&&i<=t||setTimeout(()=>{E[n](e)},a*t)})}function me(){oe("rumble",.3),re(),d.currentShakeDuration=c.shake.minDurationMS/1e3}function pe(){c.eyes.frames.reduce((e,t)=>e.then(()=>{return T((e=t)[0],e[2],e[1]),te(e[3]);var e}),Promise.resolve()).then(()=>{setTimeout(me,500)})}function x(){F()&&(d.ticketSpawned=!0,d.responseGenerated=!1,ne(),pe(),ee({callback:e=>{d.responseGenerated=!0,j(e.currentImageBack)}}))}function ue(e){w.x=e.clientX/window.innerWidth*2-1,w.y=2*-(e.clientY/window.innerHeight)+1,u.setFromCamera(w,f);var t,e=u.intersectObjects([S,L,v]).map(e=>e.object);((t=e).includes(S)||t.includes(L))&&d.ticketSpawned&&d.ticketDoneSliding&&L.parent===m?($(),T("remove",10),m.remove(L),d.ticketSpawned=!1,y.API.enabled=!1):e.includes(v)&&x()}function we(e){" "===e.key&&x()}function A(){var e=window.innerWidth,t=window.innerHeight;h.setSize(e,t),f.aspect=e/t,f.updateProjectionMatrix()}function G(){return!s()&&!d.ticketSpawned&&!U()}function I(){var e=se.getDelta(),t={state:d,options:c,ticket:L,camera:f,scene:m,ambient:k};Z(e,t),J(e,t),K(e,t),N(e,t),y.update(e),h.render(m,f),requestAnimationFrame(I)}m.add(E),ie(G),document.addEventListener("DOMContentLoaded",function(){l.buttons=[document.querySelector("#save-button"),document.querySelector("#discard-button")],l.buttons.forEach(e=>{e.addEventListener("click",()=>{y.API.enabled=!0})}),h.domElement.addEventListener("click",ue),window.addEventListener("keydown",we),window.addEventListener("resize",A),h.domElement.addEventListener("mouseenter",A),window.addEventListener("beforeunload",e=>{G()?e.preventDefault():e.returnValue="Leaving now will cause your ticket to be lost. Are you sure?"}),p.onLoad=()=>{_(y)},I()});export{y as controls,F as canTriggerEvent,j as setTicketMapToImage};